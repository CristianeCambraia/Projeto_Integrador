{% extends 'base.html' %}

{% block content %}
<div class="container">
  <section class="form-box">
    <h2 class="form-title">{{ titulo_pagina }}</h2>

    <form method="post" action="{% url 'cadastrar_produto' %}">
      {% csrf_token %}
      
      <!-- Campo de Código de Barras Grande -->
      <div class="barcode-field">
        <div class="barcode-input-container">
          {{ form.codigo_barras }}

        </div>
      </div>
      
      <!-- Outros Campos -->
      <div class="form-grid">
        {{ form.nome }}
        {{ form.quantidade }}
        {{ form.preco }}
        <div style="display: flex; flex-direction: column;">
          <label style="display: block; margin-bottom: 5px; font-weight: bold; text-align: center; visibility: hidden;">Espaço:</label>
          {{ form.fornecedor }}
        </div>
        <div style="display: flex; flex-direction: column;">
          <label style="display: block; margin-bottom: 5px; font-weight: bold; text-align: center; visibility: hidden;">Espaço:</label>
          {{ form.unidade }}
        </div>
        <div>
          <label for="id_validade" style="display: block; margin-bottom: 5px; font-weight: bold; text-align: center;">Data de Validade:</label>
          {{ form.validade }}
        </div>
        {{ form.descricao }}
        {{ form.observacao }}
      </div>

      <div class="form-buttons">
        <a href="{% url 'lista_produtos' %}" class="btn btn-editar">Ver Produtos</a>
        <button type="submit" class="btn btn-salvar">Salvar</button>
        <a href="{% url 'fornecedores' %}" class="btn btn-voltar">Voltar</a>
      </div>

    </form>
  </section>
</div>

<style>
.barcode-field {
  margin-bottom: 20px;
}

.barcode-input-container {
  position: relative;
  max-width: 100%;
}

.barcode-input-container input {
  width: 100%;
  height: 50px;
  font-size: 16px;
  padding: 12px 60px 12px 12px;
  border: 2px solid #ddd;
  border-radius: 5px;
  background-color: #f9f9f9;
  box-sizing: border-box;
}

.barcode-icon {
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 16px;
  color: #666;
  pointer-events: none;
  font-family: monospace;
  letter-spacing: 1px;
}

.barcode-input-container input:focus {
  border-color: #007bff;
  background-color: #fff;
  outline: none;
}
</style>

<script>
// Otimização para leitor de código de barras
document.addEventListener('DOMContentLoaded', function() {
    const codigoBarrasField = document.getElementById('id_codigo_barras');
    if (codigoBarrasField) {
        let timeout;
        codigoBarrasField.addEventListener('input', function() {
            clearTimeout(timeout);
            const codigo = this.value.trim();
            
            if (codigo.length > 5) {
                timeout = setTimeout(() => {
                    // Buscar produto existente pelo código
                    fetch('/buscar-produto-por-codigo/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: JSON.stringify({codigo_barras: codigo})
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.encontrado) {
                            // Preencher campos com dados do produto
                            document.getElementById('id_nome').value = data.nome;
                            document.getElementById('id_preco').value = data.preco;
                            if (data.descricao) document.getElementById('id_descricao').value = data.descricao;
                            if (data.fornecedor) document.getElementById('id_fornecedor').value = data.fornecedor;
                            document.getElementById('id_unidade').value = data.unidade;
                            if (data.observacao) document.getElementById('id_observacao').value = data.observacao;
                        }
                        // Auto-focus no próximo campo
                        document.getElementById('id_nome').focus();
                    })
                    .catch(() => {
                        // Em caso de erro, apenas move o foco
                        document.getElementById('id_nome').focus();
                    });
                }, 300);
            }
        });
    }
});
</script>
{% endblock %}
