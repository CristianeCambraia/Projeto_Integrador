{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
.caixa-titulo {
  background-color: #f9f9f9;
  padding: 10px;
  border-radius: 5px;
  margin-bottom: 10px;
  border: 1px solid #ddd;
  text-align: center;
}

.caixa-titulo span, .caixa-titulo h4 {
  margin: 0;
  font-weight: bold;
  font-size: 18px;
}

@media print {
  @page {
    margin: 0.5in;
    size: A4;
  }
  
  header, footer, .botoes {
    display: none !important;
  }
  
  body {
    margin: 0 !important;
    padding: 0 !important;
    width: 100% !important;
    max-width: none !important;
    font-size: 12px !important;
  }
  
  .print-header {
    display: table !important;
    padding-top: 20px !important;
  }
  
  .emitir-orcamento-container {
    width: 100% !important;
    max-width: none !important;
    margin: 0 auto !important;
    padding: 0 !important;
  }
  

  
  * {
    -webkit-print-color-adjust: exact !important;
    color-adjust: exact !important;
  }
  
  .caixa-titulo {
    background-color: #f9f9f9 !important;
    border: 1px solid #ddd !important;
    padding: 8px !important;
    border-radius: 3px !important;
    margin-bottom: 8px !important;
    text-align: center !important;
    width: 100% !important;
    box-sizing: border-box !important;
  }
  
  .caixa-titulo span, .caixa-titulo h4 {
    font-weight: bold !important;
    font-size: 14px !important;
    margin: 0 !important;
  }
  
  h2.titulo {
    padding-top: 30px !important;
    margin-top: 0 !important;
  }
  
  table {
    width: 100% !important;
    font-size: 10px !important;
    table-layout: fixed !important;
  }
  
  table input {
    font-size: 12px !important;
    padding: 5px !important;
    border-radius: 5px !important;
    border: 1px solid #ddd !important;
  }
  
  .cliente-dados {
    width: 100% !important;
    font-size: 11px !important;
  }
  
  input, textarea {
    font-size: 10px !important;
    padding: 16px !important;
    text-align: left !important;
    padding-left: 30px !important;
    width: auto !important;
    min-width: 100% !important;
    max-width: none !important;
    overflow: visible !important;
    text-overflow: clip !important;
    white-space: nowrap !important;
  }
  
  div[style*="text-align: right"] {
    text-align: right !important;
  }
  
  * {
    box-sizing: border-box !important;
  }
  
  div {
    text-align: inherit !important;
  }
  
  div[style*="text-align: right"] {
    text-align: right !important;
    direction: rtl !important;
    width: 30% !important;
    display: inline-block !important;
    float: right !important;
    max-width: 250px !important;
  }
  
  div[style*="text-align: right"] * {
    direction: ltr !important;
    text-align: right !important;
  }
  
  div.emitir-orcamento-container {
    border-radius: 0 !important;
    border-top-left-radius: 0 !important;
    border-top-right-radius: 0 !important;
    border-bottom-left-radius: 0 !important;
    border-bottom-right-radius: 0 !important;
  }
  
  div[style*="border-radius"] {
    border-radius: 0 !important;
  }
}

.print-header {
  display: none;
}

.valores-totais input {
  text-align: right !important;
}

.itens-orcamento input {
  font-size: 12px !important;
  padding: 5px !important;
  border-radius: 5px !important;
  border: 1px solid #ddd !important;
  background-color: #f0f0f0 !important;
}

input:not(.valores-totais input):not(.itens-orcamento input), textarea {
  width: auto !important;
  min-width: 100% !important;
  max-width: none !important;
  overflow: visible !important;
  text-overflow: clip !important;
  white-space: nowrap !important;
}


</style>

<div class="print-header">
  <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding: 0 80px;">
    <img src="{% static 'images/insumed_icon.png' %}" style="width: 100px; height: 100px;" alt="Logo">
    <h1 style="font-size: 48px; font-weight: bold; color: rgba(0, 0, 0, 0.12); margin: 0 120px; word-wrap: break-word; line-height: 1.2;">INSUMED</h1>
    <img src="{% static 'images/insumed_icon.png' %}" style="width: 100px; height: 100px;" alt="Logo">
  </div>
</div>
<div class="emitir-orcamento-container">
  <h2 class="titulo" style="margin-bottom: 30px;">Orçamento #{{ orcamento.id }}</h2>
  
  <div class="caixa-titulo" style="width: 100%; box-sizing: border-box; margin-bottom: 20px;">
      <h4>Dados da Empresa INSUMED</h4>
  </div>
  <div style="background-color: #f9f9f9; padding: 10px; border-radius: 5px; margin-bottom: 20px; border: 1px solid #ddd; width: 100%; box-sizing: border-box;">
      <div style="display: grid; grid-template-columns: 1.8fr 1fr 1.4fr 0.8fr; gap: 8px; width: 100%;">
          <div>
              <label style="font-size: 12px; color: #666;">Endereço:</label>
              <input type="text" name="endereco_insumed" value="Rua das Flores, 123 - Centro - Pouso Alegre - MG" disabled style="width: 100%; padding: 5px; font-size: 12px; box-sizing: border-box; border-radius: 5px; border: 1px solid #ddd; background-color: #f0f0f0;">
          </div>
          <div>
              <label style="font-size: 12px; color: #666;">CNPJ:</label>
              <input type="text" name="cnpj_insumed" value="12.345.678/0001-90" disabled style="width: 100%; padding: 5px; font-size: 12px; box-sizing: border-box; border-radius: 5px; border: 1px solid #ddd; background-color: #f0f0f0;">
          </div>
          <div>
              <label style="font-size: 12px; color: #666;">E-mail:</label>
              <input type="email" name="email_insumed" value="insumed.sistema2025@gmail.com" disabled style="width: 100%; padding: 5px; font-size: 12px; box-sizing: border-box; border-radius: 5px; border: 1px solid #ddd; background-color: #f0f0f0;">
          </div>
          <div>
              <label style="font-size: 12px; color: #666;">Telefone:</label>
              <input type="text" name="telefone_insumed" value="(35) 98412-3236" disabled style="width: 100%; padding: 5px; font-size: 12px; box-sizing: border-box; border-radius: 5px; border: 1px solid #ddd; background-color: #f0f0f0;">
          </div>
      </div>
  </div>

  <form class="form-box"  method="post" action="#">
    {% csrf_token %}

    <div class="caixa-titulo">
      <span>Dados do Cliente</span>
    </div>

    <div class="cliente-dados">
      <div>
        <label><strong>Cliente:</strong></label>
        <input type="text" name="cliente" value="{{ orcamento.cliente }}" disabled>
      </div>
                    
      <div>
        <label><strong>Data:</strong></label>
        <input type="date" name="data" value="{{ orcamento.data|date:'Y-m-d' }}" disabled>
      </div>
                    
      <div>
        <label><strong>CNPJ:</strong></label>
        <input type="text" name="cnpj" value="{{ orcamento.cnpj }}" disabled>
      </div>
                    
      <div>
        <label><strong>Endereço:</strong></label>
        <input type="text" name="endereco" value="{{ orcamento.endereco }}" disabled>
      </div>
                    
      <div>
        <label><strong>Cidade:</strong></label>
        <input type="text" name="cidade" value="{{ orcamento.cidade }}" disabled>
      </div>
                    
      <div>
        <label><strong>UF:</strong></label>
        <input type="text" name="uf" value="{{ orcamento.uf|default:'' }}" disabled>
      </div>
                    
      <div>
        <label><strong>E-mail:</strong></label>
        <input type="email" name="email" value="{{ orcamento.email }}" disabled>
      </div>
                    
      <div>
        <label><strong>Telefone:</strong></label>
        <input type="tel" name="telefone" value="{{ orcamento.telefone }}" disabled>
      </div>

    </div>

    <div class="caixa-titulo">
      <span>Descrição do Serviço</span>
    </div>

    <table class="itens-orcamento">
      <thead>
        <tr>
          <th>Unidade/Serviço</th>
          <th>Descrição</th>
          <th>Quantidade</th>
          <th>Valor</th>
        </tr>
      </thead>
      <tbody>
        {% for linha in linhas %}
        <tr>
          <td><input type="text" name="unidade_{{ forloop.counter }}" value="{{ linha.unidade }}" disabled></td>
          <td><input type="text" name="descricao_{{ forloop.counter }}" value="{{ linha.descricao }}" disabled></td>
          <td><input type="number" name="quantidade_{{ forloop.counter }}" min="1" value="{{ linha.quantidade }}" disabled></td>
          <td><input type="text" name="valor_{{ forloop.counter }}" value="{{ linha.valor }}" disabled></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="valores-totais" style="margin: 20px 0; text-align: right;">
        <div style="margin-bottom: 10px;">
            <label><strong>Subtotal: R$ </strong></label>
            <input type="text" id="subtotal" value="{{ orcamento.subtotal_calculado }}" readonly style="background-color: #f0f0f0; font-weight: bold; width: 150px;">
        </div>
        {% if orcamento.desconto %}
        <div style="margin-bottom: 10px;">
            <label><strong>Desconto ({{ orcamento.desconto }}%): R$ </strong></label>
            <input type="text" id="valorDesconto" value="{{ orcamento.valor_desconto_calculado }}" readonly style="background-color: #f0f0f0; font-weight: bold; width: 150px;">
        </div>
        {% endif %}
        <div>
            <label><strong>Valor Total: R$ </strong></label>
            <input type="text" id="valorTotal" name="valor_total" value="{{ orcamento.valor_total_calculado }}" readonly style="background-color: #f0f0f0; font-weight: bold; width: 150px;">
        </div>
    </div>

    <div class="observacao-container">
        <label><strong>Observação:</strong></label>
        <textarea name="observacao" rows="4" disabled>{{ orcamento.observacao }}</textarea>
    </div>

    <div class="botoes">
      <button type="button" onclick="window.print()" class="btn-salvar" style="background: #17a2b8;">Imprimir</button>
      <button type="button" onclick="abrirModalEmail({{ orcamento.id }})" class="btn-emitidos" style="background: #28a745;">Email</button>
      <a href="{% url 'exportar_pdf_orcamento' orcamento.id %}" class="btn-emitidos" style="background: #dc3545;">PDF</a>
      <a href="{% url 'orcamentos_emitidos' %}" class="btn-voltar">Voltar ⤴</a>
    </div>
  </form>
</div>

<script>
function criarModalEmail() {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
    `;
    
    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
        background: #e8e8e8;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        max-width: 400px;
        width: 90%;
        text-align: center;
        font-family: Arial, sans-serif;
    `;
    
    modalContent.innerHTML = `
        <h3 style="color: #026a84; margin-bottom: 20px; font-size: 20px;">📧 Enviar Orçamento por Email</h3>
        <p style="color: #666; margin-bottom: 20px;">Digite o endereço de email de destino:</p>
        <input type="email" id="emailInput" placeholder="exemplo@email.com" style="
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
            box-sizing: border-box;
            outline: none;
        ">
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button id="cancelarBtn" style="
                background: #6c757d;
                color: white;
                border: none;
                padding: 12px 20px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                font-weight: bold;
            ">Cancelar</button>
            <button id="enviarBtn" style="
                background: #28a745;
                color: white;
                border: none;
                padding: 12px 20px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                font-weight: bold;
            ">Enviar</button>
        </div>
    `;
    
    modal.appendChild(modalContent);
    document.body.appendChild(modal);
    
    const emailInput = document.getElementById('emailInput');
    const cancelarBtn = document.getElementById('cancelarBtn');
    const enviarBtn = document.getElementById('enviarBtn');
    
    emailInput.focus();
    
    return new Promise((resolve) => {
        cancelarBtn.onclick = () => {
            document.body.removeChild(modal);
            resolve(null);
        };
        
        enviarBtn.onclick = () => {
            const email = emailInput.value.trim();
            if (email) {
                document.body.removeChild(modal);
                resolve(email);
            } else {
                emailInput.style.border = '2px solid #dc3545';
                emailInput.focus();
            }
        };
        
        emailInput.onkeypress = (e) => {
            if (e.key === 'Enter') {
                enviarBtn.click();
            }
        };
        
        modal.onclick = (e) => {
            if (e.target === modal) {
                cancelarBtn.click();
            }
        };
    });
}

async function abrirModalEmail(orcamentoId) {
    const email = await criarModalEmail();
    if (email) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        fetch('/enviar_orcamento_email/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                orcamento_id: orcamentoId,
                email: email
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const mensagem = document.createElement('div');
                mensagem.className = 'alert alert-success';
                mensagem.style.cssText = 'position: fixed; top: 80px; right: 20px; z-index: 9999; background: white; color: #28a745; border: 2px solid #28a745; padding: 15px 20px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); font-weight: bold;';
                mensagem.textContent = 'Orçamento enviado por email com sucesso!';
                document.body.appendChild(mensagem);
                setTimeout(() => mensagem.remove(), 4000);
            } else {
                alert('Erro ao enviar orçamento: ' + data.error);
            }
        })
        .catch(error => {
            alert('Erro ao enviar orçamento.');
        });
    }
}
</script>

<style>
.emitir-orcamento-container {
    border-radius: 30px 30px 30px 30px !important;
}

/* Responsividade para Dev Tools - Header */
@media screen and (max-width: 1400px) {
    header {
        width: 100vw !important;
        padding: 12px 5px !important;
        box-sizing: border-box !important;
        margin: 0 !important;
        position: relative !important;
        left: 0 !important;
        right: 0 !important;
    }
    
    .emitir-orcamento-container {
        max-width: 100% !important;
        width: 100% !important;
        margin: 20px 0 0 0 !important;
        padding: 15px !important;
        box-sizing: border-box !important;
    }
}
</style>

{% endblock %}
