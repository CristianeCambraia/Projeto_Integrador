{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="estoque-container" style="max-width: 95%; width: 95%; margin: 0 auto;">
    <div class="print-header" style="display: none;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding: 0 80px;">
            <img src="{% static 'images/insumed_icon.png' %}" style="width: 100px; height: 100px;" alt="Logo">
            <h1 style="font-size: 48px; font-weight: bold; color: rgba(0, 0, 0, 0.12); margin: 0 120px; word-wrap: break-word; line-height: 1.2;">INSUMED</h1>
            <img src="{% static 'images/insumed_icon.png' %}" style="width: 100px; height: 100px;" alt="Logo">
        </div>
    </div>
    
    <h2 class="titulo screen-only">Balancete Financeiro</h2>
    
    <div class="print-info" style="display: none;">
        <h3 style="text-align: center; margin: 0 0 10px 0; color: #026a84; font-size: 24px;">Balancete Financeiro</h3>
        <p style="text-align: center; margin: 0; color: #026a84;">{{ titulo_periodo }}</p>
    </div>

    <!-- Filtro de Per√≠odo e Bot√µes -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <form method="GET" style="display: flex; align-items: center;">
            <select name="periodo" style="padding: 10px; font-size: 14px; border: 1px solid #ddd; border-radius: 3px; margin-right: 10px;">
                <option value="dia" {% if periodo == 'dia' %}selected{% endif %}>Hoje</option>
                <option value="mes" {% if periodo == 'mes' %}selected{% endif %}>Este M√™s</option>
                <option value="ano" {% if periodo == 'ano' %}selected{% endif %}>Este Ano</option>
                <option value="total" {% if periodo == 'total' %}selected{% endif %}>Todo o Per√≠odo</option>
            </select>
            <button type="submit" class="btn" style="background: #007bff; padding: 10px 15px;">Filtrar</button>
        </form>
        
        <div style="display: flex; gap: 10px;">
            <button type="button" onclick="window.print()" class="btn" style="background: #17a2b8; padding: 10px 15px;">Imprimir</button>
            <button type="button" onclick="enviarEmail()" class="btn" style="background: #28a745; padding: 10px 15px;">Email</button>
            <a href="{% url 'exportar_balancete_pdf' %}?periodo={{ periodo }}" class="btn" style="background: #dc3545; padding: 10px 15px; text-decoration: none; color: white;">PDF</a>
        </div>
    </div>

    <!-- Resumo do Per√≠odo -->
    <div style="background: #f8f9fa; padding: 20px; border-radius: 5px; margin-bottom: 30px;">
        <h3 style="margin-top: 0; color: #495057;">{{ titulo_periodo }}</h3>
        <p style="margin: 5px 0; color: #6c757d;">Relat√≥rio gerado em: {{ data_atual }}</p>
    </div>

    <!-- Cards de Resumo -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
        
        <!-- Card Entradas -->
        <div style="background: #e8f5e8; border: 2px solid #28a745; border-radius: 8px; padding: 20px; text-align: center;">
            <h4 style="margin: 0 0 10px 0; color: #155724;">üí∞ ENTRADAS</h4>
            <p style="font-size: 24px; font-weight: bold; margin: 10px 0; color: #28a745;">
                R$ {{ valor_entradas|floatformat:2 }}
            </p>
            <small style="color: #6c757d;">{{ total_entradas }} itens</small>
        </div>

        <!-- Card Sa√≠das -->
        <div style="background: #ffe8e8; border: 2px solid #dc3545; border-radius: 8px; padding: 20px; text-align: center;">
            <h4 style="margin: 0 0 10px 0; color: #721c24;">üì§ SA√çDAS</h4>
            <p style="font-size: 24px; font-weight: bold; margin: 10px 0; color: #dc3545;">
                R$ {{ valor_saidas|floatformat:2 }}
            </p>
            <small style="color: #6c757d;">{{ total_saidas }} itens</small>
        </div>

        <!-- Card Lucro -->
        <div style="background: {% if lucro >= 0 %}#e8f4fd{% else %}#fff3cd{% endif %}; border: 2px solid {% if lucro >= 0 %}#007bff{% else %}#ffc107{% endif %}; border-radius: 8px; padding: 20px; text-align: center;">
            <h4 style="margin: 0 0 10px 0; color: {% if lucro >= 0 %}#004085{% else %}#856404{% endif %};">
                {% if lucro >= 0 %}üìà SALDO{% else %}‚ö†Ô∏è SALDO{% endif %}
            </h4>
            <p style="font-size: 24px; font-weight: bold; margin: 10px 0; color: {% if lucro >= 0 %}#007bff{% else %}#ffc107{% endif %};">
                R$ {{ lucro|floatformat:2 }}
            </p>
            <small style="color: #6c757d;">
                {% if lucro >= 0 %}
                    Resultado positivo
                {% else %}
                    Resultado negativo
                {% endif %}
            </small>
        </div>
    </div>

    <!-- Detalhamento -->
    <div style="background: white; border: 1px solid #dee2e6; border-radius: 5px; padding: 20px;">
        <h4 style="margin-top: 0; color: #495057;">üìä Detalhamento</h4>
        
        <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
            <thead>
                <tr style="background: #f8f9fa;">
                    <th style="padding: 12px; text-align: left; border: 1px solid #dee2e6;">Descri√ß√£o</th>
                    <th style="padding: 12px; text-align: right; border: 1px solid #dee2e6;">Quantidade</th>
                    <th style="padding: 12px; text-align: right; border: 1px solid #dee2e6;">Valor (R$)</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td style="padding: 12px; border: 1px solid #dee2e6;">
                        <span style="color: #28a745; font-weight: bold;">‚ûï Total de Entradas</span>
                    </td>
                    <td style="padding: 12px; text-align: right; border: 1px solid #dee2e6;">{{ total_entradas }}</td>
                    <td style="padding: 12px; text-align: right; border: 1px solid #dee2e6; color: #28a745; font-weight: bold;">
                        {{ valor_entradas|floatformat:2 }}
                    </td>
                </tr>
                <tr>
                    <td style="padding: 12px; border: 1px solid #dee2e6;">
                        <span style="color: #dc3545; font-weight: bold;">‚ûñ Total de Sa√≠das</span>
                    </td>
                    <td style="padding: 12px; text-align: right; border: 1px solid #dee2e6;">{{ total_saidas }}</td>
                    <td style="padding: 12px; text-align: right; border: 1px solid #dee2e6; color: #dc3545; font-weight: bold;">
                        {{ valor_saidas|floatformat:2 }}
                    </td>
                </tr>
                <tr style="background: #f8f9fa; font-weight: bold;">
                    <td style="padding: 12px; border: 1px solid #dee2e6;">
                        <span style="color: {% if lucro >= 0 %}#007bff{% else %}#ffc107{% endif %};">
                            {% if lucro >= 0 %}üí∞ SALDO L√çQUIDO{% else %}‚ö†Ô∏è SALDO L√çQUIDO{% endif %}
                        </span>
                    </td>
                    <td style="padding: 12px; text-align: right; border: 1px solid #dee2e6;">-</td>
                    <td style="padding: 12px; text-align: right; border: 1px solid #dee2e6; color: {% if lucro >= 0 %}#007bff{% else %}#ffc107{% endif %}; font-size: 18px;">
                        {{ lucro|floatformat:2 }}
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Rodap√© do Relat√≥rio -->
    <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 5px; text-align: center; font-size: 12px; color: #666;">
        <p style="margin: 5px 0;">Relat√≥rio gerado automaticamente pelo Sistema INSUMED</p>
        <p style="margin: 5px 0;">Este documento apresenta o resumo financeiro das movimenta√ß√µes de estoque</p>
    </div>

    <!-- Bot√µes de Navega√ß√£o -->
    <div class="botoes" style="margin-top: 20px;">
        <button onclick="location.reload()" class="btn" style="background: #007bff;">Atualizar</button>
        <a href="{% url 'relatorio_estoque' %}" class="btn">Relat√≥rio de Estoque</a>
        <a href="{% url 'relatorio_entrada' %}" class="btn">Lan√ßamento de Entrada</a>
        <a href="{% url 'relatorio_saida' %}" class="btn">Lan√ßamento de Sa√≠da</a>
    </div>
</div>

<style>
@media print {
    @page {
        margin: 0;
        size: A4;
        background: #013e6a !important;
    }
    * {
        -webkit-print-color-adjust: exact !important;
        color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
    body * {
        visibility: hidden;
    }
    html {
        background: #013e6a !important;
        -webkit-print-color-adjust: exact !important;
        color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
    body {
        margin: 0;
        padding: 0;
        background: #013e6a !important;
        -webkit-print-color-adjust: exact !important;
        color-adjust: exact !important;
        print-color-adjust: exact !important;
        min-height: 100vh;
        visibility: visible;
    }
    .estoque-container, .estoque-container * {
        visibility: visible;
    }
    .btn, form select, form button, form a, .botoes, .screen-only {
        display: none !important;
    }
    .print-header, .print-info {
        display: block !important;
    }
    .print-header {
        background: #013e6a !important;
        position: absolute;
        top: 0;
        left: 0;
        width: 100vw;
        height: 120px;
        z-index: 10;
        padding: 20px 0 !important;
        margin: 0 !important;
    }
    .print-info {
        display: block !important;
        background: #e8e8e8 !important;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 5px;
        margin-top: 130px;
    }
    .estoque-container {
        margin-top: 0 !important;
        padding: 20px;
        position: relative;
    }
    .print-header h1 {
        color: rgba(255, 255, 255, 0.3) !important;
    }
    header, footer {
        display: none !important;
    }
    main {
        margin: 0 !important;
        padding: 0 !important;
    }
    /* For√ßar cards na mesma linha na impress√£o */
    div[style*="grid-template-columns"] {
        display: flex !important;
        gap: 10px !important;
        background: white !important;
    }
    div[style*="grid-template-columns"] > div {
        flex: 1 !important;
        min-width: 0 !important;
        padding: 15px 10px !important;
        font-size: 12px !important;
    }
    div[style*="grid-template-columns"] h4 {
        font-size: 12px !important;
        margin: 0 0 8px 0 !important;
    }
    div[style*="grid-template-columns"] p {
        font-size: 18px !important;
        margin: 8px 0 !important;
    }
    div[style*="grid-template-columns"] small {
        font-size: 10px !important;
    }
}
</style>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function enviarEmail() {
    const email = prompt('Digite o email de destino:');
    if (email) {
        const periodo = '{{ periodo }}';
        const csrfToken = getCookie('csrftoken');
        
        fetch('/enviar-balancete-email/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({email: email, periodo: periodo})
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Erro na requisi√ß√£o: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                const mensagem = document.createElement('div');
                mensagem.className = 'alert alert-success';
                mensagem.style.cssText = 'position: fixed; top: 80px; right: 20px; z-index: 9999; background: white; color: #28a745; border: 2px solid #28a745; padding: 15px 20px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); font-weight: bold;';
                mensagem.textContent = 'Balancete enviado por email com sucesso!';
                document.body.appendChild(mensagem);
                setTimeout(() => mensagem.remove(), 4000);
            } else {
                alert('Erro ao enviar email: ' + (data.error || 'Erro desconhecido'));
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao enviar email: ' + error.message);
        });
    }
}
</script>
{% endblock %}