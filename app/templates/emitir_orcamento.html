{% extends 'base.html' %}

{% block content %}
<div class="emitir-orcamento-container">
    <h2 class="titulo">Emitir Or√ßamentos</h2>

    <form class="form-box"  method="post" action="{% url 'salvar_orcamento' %}">
        {% csrf_token %}

        <div class="cliente-dados">
            <div>
                <label><strong>Cliente:</strong></label>
                <input type="text" name="cliente" id="cliente-input" autocomplete="off" required>
                <div id="cliente-suggestions" style="display: none; position: absolute; background: white; border: 1px solid #ccc; max-height: 200px; overflow-y: auto; z-index: 1000;"></div>
            </div>
                    
            <div>
                <label><strong>Data:</strong></label>
                <input type="date" name="data" id="data_orcamento" required>
            </div>
                    
            <div>
                <label><strong>CNPJ:</strong></label>
                <input type="text" name="cnpj" maxlength="18" placeholder="XX.XXX.XXX/XXXX-XX" oninput="formatCNPJ(this)" onkeypress="return /[0-9]/.test(event.key) || event.key === 'Backspace'" required>
            </div>
                    
            <div>
                <label><strong>Endere√ßo:</strong></label>
                <input type="text" name="endereco">
            </div>
                    
            <div>
                <label><strong>Cidade:</strong></label>
                <input type="text" name="cidade">
            </div>
                    
            <div>
                <label><strong>Telefone:</strong></label>
                <input type="tel" name="telefone" onkeypress="return event.charCode >= 48 && event.charCode <= 57" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
            </div>
                    
            <div>
                <label><strong>E-mail:</strong></label>
                <input type="email" name="email">
            </div>

        </div>

        <table class="itens-orcamento">
            <thead>
                <tr>
                    <th>Descri√ß√£o</th>
                    <th>Quantidade</th>
                    <th>Valor</th>
                </tr>
            </thead>
            <tbody id="itens-tbody">
                <tr>
                    <td><input type="text" name="descricao_1"></td>
                    <td><input type="number" name="quantidade_1" min="1"></td>
                    <td><input type="text" name="valor_1"></td>
                </tr>
            </tbody>
        </table>

        <button type="button" onclick="adicionarLinha()" class="btn-adicionar">+ Adicionar Item</button>

        <div class="observacao-container">
            <label><strong>Observa√ß√µes / Valor Total:</strong></label>
            <textarea name="observacao" rows="4" placeholder="Digite observa√ß√µes e o valor total do or√ßamento..."></textarea>
        </div>

        <div class="botoes">
            <button type="submit" class="btn-salvar">Salvar üíæ</button>
            <a href="{% url 'orcamentos_emitidos' %}" class="btn-emitidos">Or√ßamentos Emitidos ‚ûï</a>
            <a href="{% url 'home' %}" class="btn-voltar">Voltar ‚§¥</a>
        </div>
    </form>
</div>

<script>
function formatCNPJ(input) {
    let v = input.value.replace(/\D/g, '');
    v = v.substring(0, 14);
    if (v.length > 2) v = v.replace(/(\d{2})(\d)/, '$1.$2');
    if (v.length > 5) v = v.replace(/(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
    if (v.length > 8) v = v.replace(/(\d{2})\.(\d{3})\.(\d{3})(\d)/, '$1.$2.$3/$4');
    if (v.length > 12) v = v.replace(/(\d{2})\.(\d{3})\.(\d{3})\/(\d{4})(\d)/, '$1.$2.$3/$4-$5');
    input.value = v;
}

// Definir data atual como padr√£o e limitar sele√ß√£o
document.addEventListener('DOMContentLoaded', function() {
    const dataInput = document.getElementById('data_orcamento');
    const hoje = new Date().toISOString().split('T')[0];
    
    dataInput.value = hoje;
    dataInput.min = hoje;
    dataInput.max = hoje;
});

// Contador para novos itens
let contadorItens = 1;

// Fun√ß√£o para adicionar nova linha de item
function adicionarLinha() {
    contadorItens++;
    const tbody = document.getElementById('itens-tbody');
    const novaLinha = document.createElement('tr');
    
    novaLinha.innerHTML = `
        <td><input type="text" name="descricao_${contadorItens}"></td>
        <td><input type="number" name="quantidade_${contadorItens}" min="1"></td>
        <td><input type="text" name="valor_${contadorItens}"></td>
    `;
    
    tbody.appendChild(novaLinha);
}

// Autocomplete para clientes
document.addEventListener('DOMContentLoaded', function() {
    const clienteInput = document.getElementById('cliente-input');
    const suggestions = document.getElementById('cliente-suggestions');
    let timeout;

    clienteInput.addEventListener('input', function() {
        clearTimeout(timeout);
        const termo = this.value.trim();
        
        if (termo.length < 2) {
            suggestions.style.display = 'none';
            return;
        }
        
        timeout = setTimeout(() => {
            fetch(`/buscar-clientes/?termo=${encodeURIComponent(termo)}`)
                .then(response => response.json())
                .then(data => {
                    suggestions.innerHTML = '';
                    
                    if (data.clientes.length > 0) {
                        data.clientes.forEach(cliente => {
                            const div = document.createElement('div');
                            div.style.padding = '10px';
                            div.style.cursor = 'pointer';
                            div.style.borderBottom = '1px solid #eee';
                            div.textContent = cliente.nome;
                            
                            div.addEventListener('click', function() {
                                // Preencher campos com dados do cliente
                                document.querySelector('input[name="cliente"]').value = cliente.nome;
                                document.querySelector('input[name="endereco"]').value = cliente.endereco;
                                document.querySelector('input[name="cidade"]').value = cliente.cidade;
                                document.querySelector('input[name="telefone"]').value = cliente.telefone;
                                document.querySelector('input[name="email"]').value = cliente.email;
                                document.querySelector('input[name="cnpj"]').value = cliente.cpf;
                                
                                suggestions.style.display = 'none';
                            });
                            
                            suggestions.appendChild(div);
                        });
                        suggestions.style.display = 'block';
                    } else {
                        suggestions.style.display = 'none';
                    }
                })
                .catch(() => {
                    suggestions.style.display = 'none';
                });
        }, 300);
    });
    
    // Esconder sugest√µes ao clicar fora
    document.addEventListener('click', function(e) {
        if (!clienteInput.contains(e.target) && !suggestions.contains(e.target)) {
            suggestions.style.display = 'none';
        }
    });
});
</script>

{% endblock %}
