{% extends 'base.html' %}

{% block content %}
<div class="container">
  <section class="form-box">
    <h2 class="form-title">Cadastro de Fornecedores</h2>

    <form method="post" action="{% url 'salvar_fornecedor' %}">
      {% csrf_token %}
      <div class="form-grid">

        <div class="form-group">
          <label for="id_nome">Nome</label>
          <input type="text" name="nome" id="id_nome" placeholder="Nome" required>
        </div>

        <div class="form-group">
          <label for="id_data_nascimento">Data de Nascimento</label>
          <input type="date" name="data_nascimento" id="id_data_nascimento" max="2006-12-31" title="Idade deve ser maior ou igual a 18 anos" onchange="validateAge(this)" required>
        </div>

        <div class="form-group">
          <label for="id_cnpj">CNPJ</label>
          <input type="text" name="cnpj" id="id_cnpj" placeholder="XX.XXX.XXX/XXXX-XX" maxlength="18" oninput="formatCNPJ(this)" onkeypress="return /[0-9]/.test(event.key) || event.key === 'Backspace'" required>
        </div>

        <div class="form-group">
          <label for="id_endereco">Endereço</label>
          <input type="text" name="endereco" id="id_endereco" placeholder="Endereço" required>
        </div>

        <div class="form-group">
          <label for="id_bairro">Bairro</label>
          <input type="text" name="bairro" id="id_bairro" placeholder="Bairro" required>
        </div>

        <div class="form-group">
          <label for="id_complemento">Complemento</label>
          <input type="text" name="complemento" id="id_complemento" placeholder="Complemento">
        </div>

        <div class="form-group">
          <label for="id_cidade">Cidade</label>
          <input type="text" name="cidade" id="id_cidade" placeholder="Cidade" required>
        </div>

        <div class="form-group">
          <label for="id_uf">UF</label>
          <input type="text" name="uf" id="id_uf" placeholder="UF" maxlength="2" required>
        </div>

        <div class="form-group">
          <label for="id_cep">CEP</label>
          <input type="text" name="cep" id="id_cep" placeholder="XXXXX-XXX" maxlength="9" oninput="formatCEP(this)" onkeypress="return /[0-9]/.test(event.key) || event.key === 'Backspace'" required>
        </div>

        <div class="form-group">
          <label for="id_email">E-mail</label>
          <input type="email" name="email" id="id_email" placeholder="E-mail" required>
        </div>

        <div class="form-group">
          <label for="id_telefone">Telefone</label>
          <input type="text" name="telefone" id="id_telefone" placeholder="(XX) XXXXX-XXXX" maxlength="15" oninput="formatTelefone(this)" onkeypress="return /[0-9]/.test(event.key) || event.key === 'Backspace'" required>
        </div>

      </div>

      <div class="form-buttons">
        <button type="submit" class="btn btn-salvar">Salvar</button>
        <a href="{% url 'home' %}" class="btn btn-voltar">Voltar ⤴</a>
      </div>

    </form>
  </section>
</div>

<script>
function formatCNPJ(input) {
    let v = input.value.replace(/\D/g, '');
    v = v.substring(0, 14);
    if (v.length > 2) v = v.replace(/(\d{2})(\d)/, '$1.$2');
    if (v.length > 5) v = v.replace(/(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
    if (v.length > 8) v = v.replace(/(\d{2})\.(\d{3})\.(\d{3})(\d)/, '$1.$2.$3/$4');
    if (v.length > 12) v = v.replace(/(\d{2})\.(\d{3})\.(\d{3})\/(\d{4})(\d)/, '$1.$2.$3/$4-$5');
    input.value = v;
}

function formatCEP(input) {
    let v = input.value.replace(/\D/g, '');
    v = v.substring(0, 8);
    if (v.length > 5) v = v.replace(/(\d{5})(\d)/, '$1-$2');
    input.value = v;
}

function formatTelefone(input) {
    let v = input.value.replace(/\D/g, '');
    v = v.substring(0, 11);
    if (v.length > 2) v = v.replace(/(\d{2})(\d)/, '($1) $2');
    if (v.length > 7) {
        if (v.length <= 10) {
            v = v.replace(/(\(\d{2}\)\s\d{4})(\d)/, '$1-$2');
        } else {
            v = v.replace(/(\(\d{2}\)\s\d{5})(\d)/, '$1-$2');
        }
    }
    input.value = v;
}

function validateAge(input) {
    let birthDate = new Date(input.value);
    let today = new Date();
    let age = today.getFullYear() - birthDate.getFullYear();
    let monthDiff = today.getMonth() - birthDate.getMonth();
    
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
        age--;
    }
    
    if (age < 18) {
        // Criar mensagem de erro no padrão do sistema
        const messageDiv = document.createElement('div');
        messageDiv.className = 'alert alert-error';
        messageDiv.style.cssText = 'background-color: #f8d7da; color: #721c24; padding: 10px; margin: 10px 0; border: 1px solid #f5c6cb; border-radius: 4px;';
        messageDiv.innerHTML = 'Erro: Por favor, insira uma data válida. A idade deve ser maior ou igual a 18 anos.';
        
        // Inserir mensagem no topo do formulário
        const form = input.closest('form');
        const firstChild = form.firstElementChild;
        form.insertBefore(messageDiv, firstChild);
        
        // Remover mensagem após 5 segundos
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.parentNode.removeChild(messageDiv);
            }
        }, 5000);
        
        input.value = '';
        input.focus();
    }
}
</script>

<style>
/* Responsividade para Dev Tools - Header */
@media screen and (max-width: 1400px) {
    header {
        width: 100vw !important;
        padding: 12px 5px !important;
        box-sizing: border-box !important;
        margin: 0 !important;
        position: relative !important;
        left: 0 !important;
        right: 0 !important;
    }
    
    .container {
        max-width: 100% !important;
        width: 100% !important;
        margin: 20px 0 0 0 !important;
        padding: 15px !important;
        box-sizing: border-box !important;
    }
}
</style>
{% endblock %}