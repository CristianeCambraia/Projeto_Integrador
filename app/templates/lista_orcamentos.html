{% extends 'base.html' %}

{% block content %}
{% if messages %}
{% for message in messages %}
<div style="text-align: center; margin: 20px 0;">
  <div class="alert alert-{{ message.tags }}" style="display: inline-block; width: auto; padding: 10px 20px;">{{ message }}</div>
</div>
{% endfor %}
{% endif %}
<div class="container-lista-orcamentos">
  <h2>Or√ßamentos Emitidos</h2>
  
  <div class="filtro-orcamentos">
    <div style="display: flex; gap: 10px; align-items: center;">
      <input type="text" id="filtroOrcamento" placeholder="Filtrar por ID, Nome ou Data (dd/mm/aaaa)" style="padding: 8px; border: 1px solid #ddd; border-radius: 3px;">
      <button onclick="limparFiltro()" class="btn-limpar" style="background: #6c757d;">Limpar</button>
    </div>
  </div>

  <ul class="lista-orcamentos">
    {% for o in orcamentos %}
      <li class="item-orcamento" data-id="{{ o.id }}" data-cliente="{{ o.cliente|lower }}" data-data="{{ o.data|date:'d/m/Y' }}">
        <div class="row-two-col">
          <div class="col-left">
            <div class="field"><strong>ID:</strong> {{ o.id }}</div>
            <div class="field"><strong>Data:</strong> {{ o.data|date:"d/m/Y" }}</div>
            <div class="field field-email"><strong>E-mail:</strong> {{ o.email }}</div>
          </div>
          <div class="col-right">
            <div class="field"><strong>Cliente:</strong> {{ o.cliente }}</div>
            <div class="field field-cnpj"><strong>CNPJ:</strong> {{ o.cnpj }}</div>
            <div class="field"><strong>Telefone:</strong> {{ o.telefone }}</div>
          </div>
        </div>
        <div class="field" style="margin-top: 10px;">
          <strong>Itens do Or√ßamento:</strong>
          {% if o.itens_processados %}
            <div class="itens-preview-{{ o.id }}">
              <button class="btn-expandir-obs" onclick="expandirItens({{ o.id }})">Ver Itens +</button>
            </div>
            <div class="itens-completos-{{ o.id }}" style="display: none; margin-top: 10px;">
              <table style="width: 100%; border-collapse: collapse; margin-top: 5px;">
                <thead>
                  <tr style="background-color: #f5f5f5;">
                    <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Unidade/Servi√ßo</th>
                    <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Descri√ß√£o</th>
                    <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Quantidade</th>
                    <th style="border: 1px solid #ddd; padding: 8px; text-align: center;">Valor</th>
                  </tr>
                </thead>
                <tbody>
                  {% for item in o.itens_processados %}
                    {% if item.unidade or item.descricao or item.quantidade or item.valor %}
                      <tr>
                        <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">{{ item.unidade|default:"-" }}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">{{ item.descricao|default:"-" }}</td>
                        <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">{{ item.quantidade|default:"-" }}</td>
                        <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">{{ item.valor|default:"-" }}</td>
                      </tr>
                    {% endif %}
                  {% endfor %}
                </tbody>
              </table>
              <button class="btn-expandir-obs" onclick="recolherItens({{ o.id }})">Ocultar Itens -</button>
            </div>
          {% else %}
            (Nenhum item cadastrado)
          {% endif %}
        </div>
        <div style="margin-top: 15px; text-align: right;">
          <div style="margin-bottom: 5px;">
            <strong>Subtotal: R$ {{ o.subtotal|default:"0,00" }}</strong>
          </div>
          {% if o.desconto %}
          <div style="margin-bottom: 5px;">
            <strong>Desconto ({{ o.desconto }}%): R$ {{ o.valor_desconto|default:"0,00" }}</strong>
          </div>
          {% endif %}
          <div style="font-size: 16px;">
            <strong>Valor Total: R$ {{ o.valor_total|default:"0,00" }}</strong>
          </div>
        </div>
        <div style="margin-top: 15px; text-align: center;">
          <a href="{% url 'abrir_orcamento' o.id %}" class="btn-info" style="background: #17a2b8;">Abrir</a>
        </div>
      </li>
    {% empty %}
      <li id="nenhumOrcamento">Nenhum or√ßamento emitido.</li>
    {% endfor %}
  </ul>

  <div class="botoes-orcamento" style="display: flex; justify-content: center; gap: 15px; margin: 30px 0;">
    <a href="https://www.nfse.gov.br/EmissorNacional/Login" target="_blank" class="btn-padrao">Portal NF-e üìÑ</a>
    <a href="{% url 'novo_orcamento' %}" class="btn-padrao voltar">Voltar ‚§¥</a>
  </div>
</div>

<!-- Bot√£o Voltar ao Topo -->
<button id="voltarTopo" onclick="voltarAoTopo()" style="
  position: fixed;
  bottom: 30px;
  right: 30px;
  background: #04bafc;
  color: white;
  border: none;
  border-radius: 50%;
  width: 60px;
  height: 60px;
  font-size: 24px;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  display: none;
  z-index: 1000;
  transition: all 0.3s ease;
">‚¨ÜÔ∏è</button>



<script>
function criarModalEmail() {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
    `;
    
    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
        background: #e8e8e8;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        max-width: 400px;
        width: 90%;
        text-align: center;
        font-family: Arial, sans-serif;
    `;
    
    modalContent.innerHTML = `
        <h3 style="color: #026a84; margin-bottom: 20px; font-size: 20px;">üìß Enviar Or√ßamento por Email</h3>
        <p style="color: #666; margin-bottom: 20px;">Digite o endere√ßo de email de destino:</p>
        <input type="email" id="emailInput" placeholder="exemplo@email.com" style="
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
            box-sizing: border-box;
            outline: none;
        ">
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button id="cancelarBtn" style="
                background: #6c757d;
                color: white;
                border: none;
                padding: 12px 20px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                font-weight: bold;
            ">Cancelar</button>
            <button id="enviarBtn" style="
                background: #28a745;
                color: white;
                border: none;
                padding: 12px 20px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                font-weight: bold;
            ">Enviar</button>
        </div>
    `;
    
    modal.appendChild(modalContent);
    document.body.appendChild(modal);
    
    const emailInput = document.getElementById('emailInput');
    const cancelarBtn = document.getElementById('cancelarBtn');
    const enviarBtn = document.getElementById('enviarBtn');
    
    emailInput.focus();
    
    return new Promise((resolve) => {
        cancelarBtn.onclick = () => {
            document.body.removeChild(modal);
            resolve(null);
        };
        
        enviarBtn.onclick = () => {
            const email = emailInput.value.trim();
            if (email) {
                document.body.removeChild(modal);
                resolve(email);
            } else {
                emailInput.style.border = '2px solid #dc3545';
                emailInput.focus();
            }
        };
        
        emailInput.onkeypress = (e) => {
            if (e.key === 'Enter') {
                enviarBtn.click();
            }
        };
        
        modal.onclick = (e) => {
            if (e.target === modal) {
                cancelarBtn.click();
            }
        };
    });
}

async function abrirModalEmail(orcamentoId) {
    const email = await criarModalEmail();
    if (email) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        fetch('/enviar_orcamento_email/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                orcamento_id: orcamentoId,
                email: email
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const mensagem = document.createElement('div');
                mensagem.className = 'alert alert-success';
                mensagem.style.cssText = 'position: fixed; top: 80px; right: 20px; z-index: 9999; background: white; color: #28a745; border: 2px solid #28a745; padding: 15px 20px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); font-weight: bold;';
                mensagem.textContent = 'Or√ßamento enviado por email com sucesso!';
                document.body.appendChild(mensagem);
                setTimeout(() => mensagem.remove(), 4000);
            } else {
                alert('Erro ao enviar or√ßamento: ' + data.error);
            }
        })
        .catch(error => {
            alert('Erro ao enviar or√ßamento.');
        });
    }
}

function expandirItens(id) {
  document.querySelector('.itens-preview-' + id).style.display = 'none';
  document.querySelector('.itens-completos-' + id).style.display = 'block';
}

function recolherItens(id) {
  document.querySelector('.itens-preview-' + id).style.display = 'block';
  document.querySelector('.itens-completos-' + id).style.display = 'none';
}

function voltarAoTopo() {
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function filtrarOrcamentos() {
  const filtro = document.getElementById('filtroOrcamento').value.toLowerCase();
  const items = document.querySelectorAll('.item-orcamento[data-id]');
  let visivel = 0;
  
  items.forEach(item => {
    const id = item.getAttribute('data-id');
    const cliente = item.getAttribute('data-cliente');
    const data = item.getAttribute('data-data');
    
    if (id.includes(filtro) || cliente.includes(filtro) || data.includes(filtro)) {
      item.style.display = 'block';
      visivel++;
    } else {
      item.style.display = 'none';
    }
  });
  
  const nenhumItem = document.getElementById('nenhumOrcamento');
  if (nenhumItem) {
    nenhumItem.style.display = visivel === 0 && filtro !== '' ? 'block' : 'none';
  }
}

function limparFiltro() {
  document.getElementById('filtroOrcamento').value = '';
  filtrarOrcamentos();
}

document.getElementById('filtroOrcamento').addEventListener('input', filtrarOrcamentos);

// Mostrar/ocultar bot√£o baseado no scroll
window.onscroll = function() {
  const botao = document.getElementById('voltarTopo');
  if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
    botao.style.display = 'block';
  } else {
    botao.style.display = 'none';
  }
};

// Hover effect
document.getElementById('voltarTopo').onmouseover = function() {
  this.style.transform = 'scale(1.1)';
  this.style.background = '#0299d1';
};

document.getElementById('voltarTopo').onmouseout = function() {
  this.style.transform = 'scale(1)';
  this.style.background = '#04bafc';
};

// Inicializar filtro quando a p√°gina carregar
document.addEventListener('DOMContentLoaded', function() {
  if (document.getElementById('filtroOrcamento')) {
    document.getElementById('filtroOrcamento').addEventListener('input', filtrarOrcamentos);
  }
});
</script>

<style>
.container-lista-orcamentos {
  border-radius: 30px 30px 30px 30px !important;
  overflow-x: hidden !important;
}
</style>
{% endblock %}
