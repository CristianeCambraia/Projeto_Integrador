{% extends 'base.html' %}

{% block content %}
{% if messages %}
{% for message in messages %}
<div style="text-align: center; margin: 20px 0;">
  <div class="alert alert-{{ message.tags }}" style="display: inline-block; width: auto; padding: 10px 20px;">{{ message }}</div>
</div>
{% endfor %}
{% endif %}
<div class="container-lista-orcamentos">
  <h2>Or√ßamentos Emitidos</h2>
  
  <div class="filtro-orcamentos">
    <form method="GET">
      <input type="number" name="filtro_id" placeholder="Filtrar por ID" value="{{ filtro_id }}">
      <button type="submit" class="btn-filtrar">Filtrar</button>
      <a href="{% url 'orcamentos_emitidos' %}" class="btn-limpar">Limpar</a>
    </form>
  </div>

  <ul class="lista-orcamentos">
    {% for o in orcamentos %}
      <li class="item-orcamento">
        <div class="row-two-col">
          <div class="col-left">
            <div class="field"><strong>ID:</strong> {{ o.id }}</div>
            <div class="field"><strong>Cliente:</strong> {{ o.cliente }}</div>
            <div class="field"><strong>Data:</strong> {{ o.data|date:"d/m/Y" }}</div>
            <div class="field"><strong>CNPJ:</strong> {{ o.cnpj }}</div>
          </div>
          <div class="col-right">
            <div class="field"><strong>Descri√ß√£o:</strong> 
              {% if o.descricao %}
                {% if o.descricao|length > 10 %}
                  <span class="descricao-preview-{{ o.id }}">{{ o.descricao|truncatechars:50 }}<button class="btn-expandir-obs" onclick="expandirDescricao({{ o.id }})">+</button></span>
                  <span class="descricao-completa-{{ o.id }}" style="display: none;">{{ o.descricao }}<button class="btn-expandir-obs" onclick="recolherDescricao({{ o.id }})">-</button></span>
                {% else %}
                  {{ o.descricao }}
                {% endif %}
              {% else %}
                (Sem descri√ß√£o)
              {% endif %}
            </div>
            <div class="field"><strong>Telefone:</strong> {{ o.telefone }}</div>
            <div class="field"><strong>E-mail:</strong> {{ o.email }}</div>
             <div class="field"><strong>Quantidades:</strong> {{ o.itens_quantidades|default:"(Sem quantidades)" }}</div>
             <div class="field"><strong>Valores:</strong> {{ o.itens_valores|default:"(Sem valores)" }}</div>
             <div class="field"><strong>Observa√ß√µes:</strong> 
               {% if o.observacao and o.observacao|length > 50 %}
                 <span class="observacao-preview-{{ o.id }}">{{ o.observacao|truncatechars:50 }}<button class="btn-expandir-obs" onclick="expandirObservacao({{ o.id }})">+</button></span>
                 <span class="observacao-completa-{{ o.id }}" style="display: none;">{{ o.observacao }}<button class="btn-expandir-obs" onclick="recolherObservacao({{ o.id }})">-</button></span>
               {% else %}
                 {{ o.observacao|default:"(Sem observa√ß√µes)" }}
               {% endif %}
             </div>
            <div style="margin-top:10px;">
              <a href="{% url 'abrir_orcamento' o.id %}" class="btn-info">Abrir</a>
              <button onclick="abrirModalEmail({{ o.id }})" class="btn-info" style="margin-left: 5px;">Enviar por Email</button>
            </div>
          </div>
        </div>
      </li>
    {% empty %}
      <li>Nenhum or√ßamento emitido.</li>
    {% endfor %}
  </ul>

  <div class="botoes-orcamento">
    <a href="{% url 'emitir_orcamento' %}" class="btn-padrao">Novo Or√ßamento ‚ûï</a>
    <a href="https://www.nfse.gov.br/EmissorNacional/Login" target="_blank" class="btn-padrao">Portal NF-e üìÑ</a>
    <a href="{% url 'novo_orcamento' %}" class="btn-padrao voltar">Voltar ‚§¥</a>
  </div>
</div>

<!-- Modal para envio de email -->
<div id="modalEmail" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
  <div style="background-color: white; margin: 15% auto; padding: 20px; border-radius: 5px; width: 400px; text-align: center;">
    <h3>Enviar Or√ßamento por Email</h3>
    <form id="formEnviarEmail">
      {% csrf_token %}
      <input type="hidden" id="orcamentoId" name="orcamento_id">
      <div style="margin-bottom: 15px;">
        <label for="emailDestino" style="display: block; margin-bottom: 5px;">Email de destino:</label>
        <input type="email" id="emailDestino" name="email" required style="width: 80%; padding: 8px;">
      </div>
      <div>
        <button type="button" onclick="fecharModalEmail()" class="btn-limpar" style="margin-right: 10px;">Cancelar</button>
        <button type="submit" class="btn-info">Enviar</button>
      </div>
    </form>
  </div>
</div>

<script>
function abrirModalEmail(orcamentoId) {
  document.getElementById('orcamentoId').value = orcamentoId;
  document.getElementById('modalEmail').style.display = 'block';
  document.getElementById('emailDestino').focus();
}

function fecharModalEmail() {
  document.getElementById('modalEmail').style.display = 'none';
  document.getElementById('emailDestino').value = '';
}

document.getElementById('formEnviarEmail').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const orcamentoId = document.getElementById('orcamentoId').value;
  const email = document.getElementById('emailDestino').value;
  
  fetch('/enviar_orcamento_email/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    },
    body: JSON.stringify({
      orcamento_id: orcamentoId,
      email: email
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      window.location.href = '/orcamentos_emitidos/?email_enviado=1';
    } else {
      alert('Erro ao enviar or√ßamento: ' + data.error);
    }
  })
  .catch(error => {
    alert('Erro ao enviar or√ßamento.');
  });
});

function expandirObservacao(id) {
  document.querySelector('.observacao-preview-' + id).style.display = 'none';
  document.querySelector('.observacao-completa-' + id).style.display = 'inline';
}

function recolherObservacao(id) {
  document.querySelector('.observacao-preview-' + id).style.display = 'inline';
  document.querySelector('.observacao-completa-' + id).style.display = 'none';
}

function expandirDescricao(id) {
  document.querySelector('.descricao-preview-' + id).style.display = 'none';
  document.querySelector('.descricao-completa-' + id).style.display = 'inline';
}

function recolherDescricao(id) {
  document.querySelector('.descricao-preview-' + id).style.display = 'inline';
  document.querySelector('.descricao-completa-' + id).style.display = 'none';
}
</script>
{% endblock %}
