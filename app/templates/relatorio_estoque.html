{% extends "base.html" %}
{% load static %}

{% block title %}Relatório de Estoque{% endblock %}

{% block content %}
<div class="estoque-container" style="max-width: 95%; width: 95%; margin: 0 auto;">
    <div class="print-header" style="display: none;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding: 0 80px;">
            <img src="{% static 'images/insumed_icon.png' %}" style="width: 100px; height: 100px;" alt="Logo">
            <h1 style="font-size: 48px; font-weight: bold; color: rgba(0, 0, 0, 0.12); margin: 0 120px; word-wrap: break-word; line-height: 1.2;">INSUMED</h1>
            <img src="{% static 'images/insumed_icon.png' %}" style="width: 100px; height: 100px;" alt="Logo">
        </div>

    </div>
    
    <h2 class="titulo screen-only">Relatório de Estoque</h2>
    
    <div class="print-info" style="display: none;">
        <h3 style="text-align: center; margin: 0 0 10px 0; color: #026a84; font-size: 24px;">Relatório de Estoque</h3>
        <p id="data-geracao-print" style="text-align: center; margin: 0; color: #026a84;"></p>
        {% if request.GET.q %}<p style="text-align: center; margin: 5px 0 0 0; color: #026a84;">Filtro aplicado: "{{ request.GET.q }}"</p>{% endif %}
    </div>

    <!-- Token CSRF oculto -->
    {% csrf_token %}
    
    <!-- Barra de pesquisa -->
    <div class="search-controls" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <input type="text" id="filtroEstoque" placeholder="Buscar por produto, fornecedor, descrição ou código de barras" style="width: 450px; padding: 8px; height: 35px; border: 1px solid #ddd; border-radius: 15px; font-size: 14px;">
            <button onclick="limparFiltro()" class="btn" style="background: #6c757d; padding: 12px 16px; height: 45px; font-size: 14px;">Limpar</button>
        </div>
        <div style="display: flex; gap: 10px;">
            <button onclick="location.reload()" class="btn" style="background: #007bff; padding: 12px 16px; height: 45px; font-size: 14px;">Atualizar Lista</button>
            <button type="button" onclick="window.print()" class="btn" style="background: #17a2b8; padding: 12px 16px; height: 45px; font-size: 14px;">Imprimir</button>
            <button type="button" onclick="enviarEmail()" class="btn" style="background: #28a745; padding: 12px 16px; height: 45px; font-size: 14px;">Email</button>
            <a href="{% url 'exportar_estoque_pdf' %}?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}{% if request.GET.periodo %}periodo={{ request.GET.periodo }}{% endif %}" class="btn" style="background: #dc3545; padding: 12px 16px; height: 45px; font-size: 14px; display: flex; align-items: center;">PDF</a>
        </div>
    </div>

    <!-- Tabela -->
    <table class="tabela-estoque">
        <thead>
            <tr>
                <th>Fornecedor</th>
                <th>Produto</th>
                <th>Qtd Cadastrada</th>
                <th>Última Entrada</th>
                <th>Última Saída</th>
                <th>Estoque Atual</th>
                <th>Unidade</th>
                <th>Preço</th>
                <th>Descrição</th>
            </tr>
        </thead>
        <tbody>
            {% for produto in produtos %}
            <tr class="produto-row" data-fornecedor="{{ produto.fornecedor.nome|lower }}" data-produto="{{ produto.nome|lower }}" data-descricao="{{ produto.descricao|default:''|lower }}" data-codigo="{{ produto.codigo_barras|default:''|lower }}">
                <td>{{ produto.fornecedor.nome }}</td>
                <td>{{ produto.nome }}</td>
                <td>
                    {{ produto.data_hora|date:"d/m/Y H:i" }}<br>
                    <small>({{ produto.quantidade }} inicial)</small>
                </td>
                <td>
                    {% if produto.ultima_entrada %}
                        {{ produto.ultima_entrada.data_hora|date:"d/m/Y H:i" }}
                        <small>(+{{ produto.ultima_entrada.quantidade }})</small>
                    {% else %}
                        <small>Sem entrada</small>
                    {% endif %}
                </td>
                <td>
                    {% if produto.ultima_saida %}
                        {{ produto.ultima_saida.data_hora|date:"d/m/Y H:i" }}
                        <small>(-{{ produto.ultima_saida.quantidade }})</small>
                    {% else %}
                        <small>Sem saída</small>
                    {% endif %}
                </td>
                <td><strong>{{ produto.quantidade }}</strong></td>
                <td>{{ produto.unidade }}</td>
                <td>R$ {{ produto.preco }}</td>
                <td class="descricao-cell">
                    {% if produto.descricao %}
                        <span class="descricao-preview">{{ produto.descricao|truncatechars:30 }}</span>
                        <span class="descricao-completa" style="display: none;">{{ produto.descricao }}</span>
                        {% if produto.descricao|length > 30 %}
                            <button type="button" class="btn-expandir-desc" onclick="toggleDescricaoTabela(this)">+</button>
                        {% endif %}
                    {% else %}
                        <small>Sem descrição</small>
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr id="nenhumProdutoEstoque"><td colspan="9">Nenhum produto encontrado</td></tr>
            {% endfor %}
        </tbody>
    </table>
    
    <div class="print-footer" style="display: none;">
        <div style="margin-top: 30px; font-size: 12px; color: #666;">
            <p>Total de produtos: <span id="total-produtos">{{ produtos|length }}</span></p>
            <p>Relatório gerado automaticamente pelo Sistema INSUMED</p>
        </div>
    </div>


    
    <!-- Espaço extra para garantir scroll -->
    <div style="height: 200px;"></div>
</div>

<script>
function toggleDescricaoTabela(btn) {
    const preview = btn.parentElement.querySelector('.descricao-preview');
    const completa = btn.parentElement.querySelector('.descricao-completa');
    
    if (preview.style.display === 'none') {
        preview.style.display = 'inline';
        completa.style.display = 'none';
        btn.textContent = '+';
    } else {
        preview.style.display = 'none';
        completa.style.display = 'inline';
        btn.textContent = '-';
    }
}

function filtrarEstoque() {
    const filtro = document.getElementById('filtroEstoque').value.toLowerCase();
    const rows = document.querySelectorAll('.produto-row');
    let visivel = 0;
    
    rows.forEach(row => {
        const fornecedor = row.getAttribute('data-fornecedor');
        const produto = row.getAttribute('data-produto');
        const descricao = row.getAttribute('data-descricao');
        const codigo = row.getAttribute('data-codigo');
        
        if (fornecedor.includes(filtro) || produto.includes(filtro) || descricao.includes(filtro) || codigo.includes(filtro)) {
            row.style.display = 'table-row';
            visivel++;
        } else {
            row.style.display = 'none';
        }
    });
    
    const nenhumItem = document.getElementById('nenhumProdutoEstoque');
    if (nenhumItem) {
        nenhumItem.style.display = visivel === 0 && filtro !== '' ? 'table-row' : 'none';
    }
}

function limparFiltro() {
    document.getElementById('filtroEstoque').value = '';
    filtrarEstoque();
}

document.getElementById('filtroEstoque').addEventListener('input', filtrarEstoque);
</script>

<style>
@media print {
    @page {
        margin: 0;
        size: A4 landscape;
        background: #013e6a !important;
    }
    * {
        -webkit-print-color-adjust: exact !important;
        color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
    body * {
        visibility: hidden;
    }
    html {
        background: #013e6a !important;
        -webkit-print-color-adjust: exact !important;
        color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
    body {
        margin: 0;
        padding: 0;
        background: #013e6a !important;
        -webkit-print-color-adjust: exact !important;
        color-adjust: exact !important;
        print-color-adjust: exact !important;
        min-height: 100vh;
        visibility: visible;
    }
    .estoque-container, .estoque-container * {
        visibility: visible;
    }
    .barra-pesquisa, .botoes, .screen-only, .search-controls {
        display: none !important;
    }
    .print-header, .print-footer {
        display: block !important;
    }
    .print-info {
        display: block !important;
        background: #e8e8e8 !important;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 5px;
        margin-top: 130px;
    }
    .screen-only {
        display: none !important;
    }
    .estoque-container {
        position: relative;
        left: 0;
        top: 0;
        width: 100%;
        max-width: 100%;
        margin: 0 auto;
    }
    .print-header {
        background: #013e6a !important;
        position: absolute;
        top: 0;
        left: 0;
        width: 100vw;
        height: 120px;
        z-index: 10;
        padding: 20px 0 !important;
        margin: 0 !important;
    }
    .estoque-container {
        margin-top: 0 !important;
        padding: 20px;
        position: relative;
    }
    .print-header {
        padding: 0 !important;
        margin: 0 !important;
    }
    .print-header h1 {
        color: rgba(255, 255, 255, 0.3) !important;
    }
    .print-header h3 {
        color: #026a84 !important;
        margin: 10px 0 !important;
    }
    .print-header p {
        color: #026a84 !important;
    }
    table {
        font-size: 14px;
        width: 100%;
        background: white !important;
    }
    th, td {
        padding: 6px;
    }
    
    div.estoque-container {
        border-radius: 0 !important;
        border-top-left-radius: 0 !important;
        border-top-right-radius: 0 !important;
        border-bottom-left-radius: 0 !important;
        border-bottom-right-radius: 0 !important;
    }
    
    div[style*="border-radius"] {
        border-radius: 0 !important;
    }

}

.estoque-container {
    border-radius: 30px 30px 30px 30px !important;
    margin-top: 20px !important;
}
</style>

<script>
// Atualizar data/hora atual
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar filtro
    if (document.getElementById('filtroEstoque')) {
        document.getElementById('filtroEstoque').addEventListener('input', filtrarEstoque);
    }
    const agora = new Date();
    const dataFormatada = agora.toLocaleString('pt-BR', {
        day: '2-digit',
        month: '2-digit', 
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
    const elementoData = document.getElementById('data-geracao');
    const elementoDataPrint = document.getElementById('data-geracao-print');
    if (elementoData) {
        elementoData.textContent = 'Data: ' + dataFormatada;
    }
    if (elementoDataPrint) {
        elementoDataPrint.textContent = 'Data: ' + dataFormatada;
    }
});

function criarModalEmail() {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
    `;
    
    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
        background: #e8e8e8;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        max-width: 400px;
        width: 90%;
        text-align: center;
        font-family: Arial, sans-serif;
    `;
    
    modalContent.innerHTML = `
        <h3 style="color: #026a84; margin-bottom: 20px; font-size: 20px;">📧 Enviar Relatório por Email</h3>
        <p style="color: #666; margin-bottom: 20px;">Digite o endereço de email de destino:</p>
        <input type="email" id="emailInput" placeholder="exemplo@email.com" style="
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
            box-sizing: border-box;
            outline: none;
        ">
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button id="cancelarBtn" style="
                background: #6c757d;
                color: white;
                border: none;
                padding: 12px 20px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                font-weight: bold;
            ">Cancelar</button>
            <button id="enviarBtn" style="
                background: #28a745;
                color: white;
                border: none;
                padding: 12px 20px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                font-weight: bold;
            ">Enviar</button>
        </div>
    `;
    
    modal.appendChild(modalContent);
    document.body.appendChild(modal);
    
    const emailInput = document.getElementById('emailInput');
    const cancelarBtn = document.getElementById('cancelarBtn');
    const enviarBtn = document.getElementById('enviarBtn');
    
    emailInput.focus();
    
    return new Promise((resolve) => {
        cancelarBtn.onclick = () => {
            document.body.removeChild(modal);
            resolve(null);
        };
        
        enviarBtn.onclick = () => {
            const email = emailInput.value.trim();
            if (email) {
                document.body.removeChild(modal);
                resolve(email);
            } else {
                emailInput.style.border = '2px solid #dc3545';
                emailInput.focus();
            }
        };
        
        emailInput.onkeypress = (e) => {
            if (e.key === 'Enter') {
                enviarBtn.click();
            }
        };
        
        modal.onclick = (e) => {
            if (e.target === modal) {
                cancelarBtn.click();
            }
        };
    });
}

async function enviarEmail() {
    const email = await criarModalEmail();
    if (email) {
        const busca = new URLSearchParams(window.location.search).get('q') || '';
        const periodo = new URLSearchParams(window.location.search).get('periodo') || '';
        
        // Obter CSRF token
        let csrfToken = '';
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) {
            csrfToken = csrfInput.value;
        } else {
            // Tentar obter do cookie
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrftoken') {
                    csrfToken = value;
                    break;
                }
            }
        }
        
        fetch('/enviar-estoque-email/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({email: email, busca: busca, periodo: periodo})
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Erro na requisição: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Criar mensagem de sucesso no estilo padrão
                const mensagem = document.createElement('div');
                mensagem.className = 'alert alert-success';
                mensagem.style.cssText = 'position: fixed; top: 80px; right: 20px; z-index: 9999; background: white; color: #28a745; border: 2px solid #28a745; padding: 15px 20px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); font-weight: bold;';
                mensagem.textContent = 'Relatório enviado por email com sucesso!';
                document.body.appendChild(mensagem);
                setTimeout(() => mensagem.remove(), 4000);
            } else {
                alert('Erro ao enviar email: ' + (data.error || 'Erro desconhecido'));
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao enviar email: ' + error.message);
        });
    }
}
</script>
{% endblock %}