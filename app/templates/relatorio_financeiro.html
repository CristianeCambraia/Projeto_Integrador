{% extends "base.html" %}
{% load static %}

{% block title %}Relat칩rio Financeiro{% endblock %}

{% block content %}
<div class="financeiro-container">
    <!-- Header Section -->
    <div class="header-section">
        <div class="icon-title">
            <div class="icon-circle">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
                    <path d="M12 2C13.1 2 14 2.9 14 4C14 4.74 13.6 5.39 13 5.73V7C13 10.76 16.05 13.81 19.81 14H4.19C7.95 13.81 11 10.76 11 7V5.73C10.4 5.39 10 4.74 10 4C10 2.9 10.9 2 12 2ZM21 16V17H3V16L5 14V7C5 3.69 7.69 1 11 1H13C16.31 1 19 3.69 19 7V14L21 16ZM9.5 18H14.5C14.5 19.66 13.16 21 11.5 21H12.5C10.84 21 9.5 19.66 9.5 18Z" fill="#2d3748"/>
                </svg>
            </div>
            <div>
                <h1>Relat칩rio Financeiro</h1>
                <p>An치lise completa de receitas e lucros</p>
            </div>
        </div>
    </div>

    <!-- Print Header -->
    <div class="print-header" style="display: none;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding: 0 80px;">
            <img src="{% static 'images/insumed_icon.png' %}" style="width: 100px; height: 100px;" alt="Logo">
            <h1 style="font-size: 48px; font-weight: bold; color: rgba(0, 0, 0, 0.12); margin: 0 120px; word-wrap: break-word; line-height: 1.2;">INSUMED</h1>
            <img src="{% static 'images/insumed_icon.png' %}" style="width: 100px; height: 100px;" alt="Logo">
        </div>
    </div>
    
    <div class="print-info" style="display: none;">
        <h3 style="text-align: center; margin: 0 0 10px 0; color: #026a84; font-size: 24px;">Relat칩rio Financeiro</h3>
        <p id="data-geracao-print" style="text-align: center; margin: 0; color: #026a84;"></p>
        {% if periodo %}<p style="text-align: center; margin: 5px 0 0 0; color: #026a84;">Per칤odo: {{ periodo }} dias</p>{% endif %}
    </div>

    <!-- Controls Section -->
    <div class="controls-section">
        <div class="section-header">
            <h3>游댌 Filtros e Controles</h3>
        </div>
        <div class="controls-content">
            <div class="search-group">
                <select onchange="filtrarPeriodo(this.value)" class="period-select">
                    <option value="" {% if not periodo %}selected{% endif %}>Todos os Per칤odos</option>
                    <option value="7" {% if periodo == '7' %}selected{% endif %}>칔ltima Semana</option>
                    <option value="30" {% if periodo == '30' %}selected{% endif %}>칔ltimo M칡s</option>
                    <option value="365" {% if periodo == '365' %}selected{% endif %}>칔ltimo Ano</option>
                </select>
            </div>
            <div class="action-buttons">
                <button onclick="location.reload()" class="btn-action btn-primary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23,4 23,10 17,10"></polyline>
                        <path d="M20.49,15a9,9,0,1,1-2.12-9.36L23,10"></path>
                    </svg>
                    Atualizar
                </button>
                <button type="button" onclick="window.print()" class="btn-action btn-info">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6,9 6,2 18,2 18,9"></polyline>
                        <path d="M6,18H4a2,2 0 0,1-2-2v-5a2,2 0 0,1,2-2H20a2,2 0 0,1,2,2v5a2,2 0 0,1-2,2H18"></path>
                        <polyline points="6,14 18,14 18,22 6,22 6,14"></polyline>
                    </svg>
                    Imprimir
                </button>
                <button type="button" onclick="enviarEmail()" class="btn-action btn-success">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                        <polyline points="22,6 12,13 2,6"></polyline>
                    </svg>
                    Email
                </button>
                <a href="{% url 'exportar_financeiro_pdf' %}?{% if periodo %}periodo={{ periodo }}{% endif %}" class="btn-action btn-danger">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14,2 14,8 20,8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                    </svg>
                    PDF
                </a>
            </div>
        </div>
    </div>

    {% csrf_token %}

    <!-- Data Section -->
    <div class="data-section">
        <div class="section-header">
            <h3>游눯 Dados Financeiros</h3>
        </div>

        <div class="table-responsive">
            <table class="modern-table">
                <thead>
                    <tr>
                        <th>Fornecedor</th>
                        <th>Produto</th>
                        <th>Quantidade</th>
                        <th>Unidade</th>
                        <th>Valor Compra</th>
                        <th>Valor Total Compra</th>
                        <th>Valor Venda</th>
                        <th>Valor Total Venda</th>
                        <th>Lucro Unit치rio</th>
                        <th>Lucro Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for produto in produtos %}
                    <tr class="produto-row" data-produto="{{ produto.nome|lower }}" data-fornecedor="{{ produto.fornecedor.nome|default:'sem fornecedor'|lower }}" data-codigo="{{ produto.codigo_barras|default:''|lower }}">
                        <td class="text-center">{{ produto.fornecedor.nome|default:"Sem fornecedor" }}</td>
                        <td class="text-center">{{ produto.nome }}</td>
                        <td class="text-center">{{ produto.quantidade }}</td>
                        <td class="text-center">{{ produto.unidade }}</td>
                        <td class="text-center">R$ {{ produto.preco_compra|default:"0,00" }}</td>
                        <td class="text-center">R$ {{ produto.valor_total_compra|default:"0,00" }}</td>
                        <td class="text-center">R$ {{ produto.preco }}</td>
                        <td class="text-center">R$ {{ produto.valor_total_venda }}</td>
                        <td class="text-center">
                            {% if produto.lucro_unitario >= 0 %}
                                <span style="color: #28a745; font-weight: bold;">R$ {{ produto.lucro_unitario }}</span>
                            {% else %}
                                <span style="color: #155724; font-weight: bold;">R$ {{ produto.lucro_unitario }}</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if produto.lucro_total >= 0 %}
                                <span style="color: #28a745; font-weight: bold;">R$ {{ produto.lucro_total }}</span>
                            {% else %}
                                <span style="color: #155724; font-weight: bold;">R$ {{ produto.lucro_total }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr id="nenhumProdutoFinanceiro">
                        <td colspan="10" class="text-center no-data">Nenhum produto encontrado</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr style="background: #f8f9fa; font-weight: bold; border-top: 2px solid #026a84;">
                        <td colspan="6" class="text-right" style="padding: 12px; font-size: 14px;">TOTAIS:</td>
                        <td class="text-center" style="padding: 12px; font-size: 14px;">R$ {{ total_compra|default:"0,00" }}</td>
                        <td class="text-center" style="padding: 12px; font-size: 14px;">R$ {{ total_venda|default:"0,00" }}</td>
                        <td class="text-center">-</td>
                        <td class="text-center" style="padding: 12px; font-size: 14px;">
                            {% if lucro_geral >= 0 %}
                                <span style="color: #28a745; font-weight: bold;">R$ {{ lucro_geral|default:"0,00" }}</span>
                            {% else %}
                                <span style="color: #155724; font-weight: bold;">R$ {{ lucro_geral|default:"0,00" }}</span>
                            {% endif %}
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    
    <div class="print-footer" style="display: none;">
        <div style="margin-top: 30px; font-size: 12px; color: #666;">
            <p>Total de lan칞amentos: <span id="total-produtos">{{ produtos|length }}</span></p>
            <p>Relat칩rio gerado automaticamente pelo Sistema INSUMED</p>
        </div>
    </div>

    <div style="height: 200px;"></div>
</div>

<script>
function filtrarPeriodo(periodo) {
    if (periodo) {
        window.location.href = `?periodo=${periodo}`;
    } else {
        window.location.href = window.location.pathname;
    }
}
</script>

<style>
/* Container Principal */
.financeiro-container {
    max-width: 95%;
    width: 95%;
    margin: 30px auto;
    background: white;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    overflow: hidden;
}

/* Header Section */
.header-section {
    background: #cbd5e0;
    padding: 30px;
    color: #2d3748;
}

.icon-title {
    display: flex;
    align-items: center;
    gap: 20px;
    justify-content: center;
    text-align: center;
}

.icon-circle {
    width: 60px;
    height: 60px;
    background: rgba(255,255,255,0.3);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(10px);
}

.header-section h1 {
    margin: 0;
    font-size: 28px;
    font-weight: 600;
}

.header-section p {
    margin: 5px 0 0 0;
    opacity: 0.9;
    font-size: 16px;
}

/* Form Sections */
.controls-section {
    padding: 30px 40px;
    margin-bottom: 0;
}

.data-section {
    padding: 10px 40px 30px 40px;
    margin-bottom: 0;
}

.section-header {
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #f0f0f0;
}

.section-header h3 {
    margin: 0;
    color: #333;
    font-size: 18px;
    font-weight: 600;
}

/* Controls */
.controls-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 20px;
    flex-wrap: wrap;
}

.search-group {
    display: flex;
    align-items: center;
    gap: 10px;
    flex: 1;
}

.period-select {
    padding: 12px 16px;
    border: 2px solid #e1e5e9;
    border-radius: 10px;
    font-size: 14px;
    background: #fafbfc;
    transition: all 0.3s ease;
    min-width: 200px;
}

.period-select:focus {
    outline: none;
    border-color: #cbd5e0;
    background: white;
}

.action-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.btn-action {
    padding: 12px 16px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
    text-decoration: none;
    color: white;
}

.btn-primary { background: #007bff; }
.btn-info { background: #17a2b8; }
.btn-success { background: #28a745; }
.btn-danger { background: #dc3545; }

.btn-action:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

/* Table */
.table-responsive {
    margin-top: 15px;
    width: 100%;
    overflow: visible;
}

.modern-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    font-size: 12px;
    table-layout: auto;
}

.modern-table th {
    background: #026a84;
    color: white;
    padding: 8px 6px;
    text-align: center;
    font-weight: bold;
    border: 1px solid #dee2e6;
    vertical-align: middle;
    font-size: 11px;
    word-wrap: break-word;
}

.modern-table td {
    padding: 6px 4px;
    border: 1px solid #dee2e6;
    vertical-align: middle;
    font-size: 11px;
    word-wrap: break-word;
    max-width: 150px;
}

.modern-table tbody tr:hover {
    background: #f8f9fa;
}

.text-center { text-align: center; }
.text-right { text-align: right; }

.no-data {
    padding: 20px;
    color: #666;
    font-style: italic;
}

/* Print Styles */
@media print {
    @page {
        margin: 0;
        size: A4 landscape;
        background: #013e6a !important;
    }
    * {
        -webkit-print-color-adjust: exact !important;
        color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
    body * {
        visibility: hidden;
    }
    html {
        background: #013e6a !important;
        -webkit-print-color-adjust: exact !important;
        color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
    body {
        margin: 0;
        padding: 0;
        background: #013e6a !important;
        -webkit-print-color-adjust: exact !important;
        color-adjust: exact !important;
        print-color-adjust: exact !important;
        min-height: 100vh;
        visibility: visible;
    }
    .financeiro-container, .financeiro-container * {
        visibility: visible;
    }
    .controls-section, .header-section {
        display: none !important;
    }
    .print-header, .print-footer {
        display: block !important;
    }
    .print-info {
        display: block !important;
        background: #e8e8e8 !important;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 5px;
        margin-top: 130px;
    }
    .print-header {
        background: #013e6a !important;
        position: absolute;
        top: 0;
        left: 0;
        width: 100vw;
        height: 120px;
        z-index: 10;
        padding: 20px 0 !important;
        margin: 0 !important;
    }
    .print-header h1 {
        color: rgba(255, 255, 255, 0.3) !important;
    }
    .modern-table {
        font-size: 8px;
        width: 100%;
        background: white !important;
        min-width: auto !important;
    }
    .modern-table th, .modern-table td {
        padding: 2px;
        font-size: 8px;
        white-space: nowrap;
    }
    .modern-table thead th {
        background: #026a84 !important;
        color: white !important;
    }
}

/* Responsividade para Dev Tools */
@media screen and (max-width: 1400px) {
    header {
        width: 100vw !important;
        padding: 12px 5px !important;
        box-sizing: border-box !important;
        margin: 0 !important;
        position: relative !important;
        left: 0 !important;
        right: 0 !important;
    }
    
    .financeiro-container {
        max-width: 100% !important;
        width: 100% !important;
        margin: 20px 0 0 0 !important;
        padding: 15px !important;
        box-sizing: border-box !important;
    }
    
    .table {
        font-size: 10px !important;
    }
    
    .table th {
        padding: 6px 4px !important;
        font-size: 10px !important;
    }
    
    .table td {
        padding: 4px 3px !important;
        font-size: 10px !important;
        max-width: 120px !important;
    }
}

@media screen and (max-width: 1200px) {
    .search-controls {
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 15px !important;
    }
    
    .search-controls > div {
        width: 100% !important;
        display: flex !important;
        flex-wrap: wrap !important;
        gap: 10px !important;
        justify-content: center !important;
    }
    
    .search-controls select {
        width: 100% !important;
        max-width: none !important;
        min-width: 300px !important;
        flex: 1 !important;
    }
    
    .search-controls .btn {
        flex: 0 0 auto !important;
        min-width: 100px !important;
    }
}

@media screen and (max-width: 768px) {
    .financeiro-container {
        margin: 10px !important;
        padding: 10px !important;
        border-radius: 15px !important;
        max-width: 98% !important;
        width: 98% !important;
    }
    
    .table {
        font-size: 9px !important;
    }
    
    .table th {
        padding: 4px 2px !important;
        font-size: 9px !important;
    }
    
    .table td {
        padding: 3px 2px !important;
        font-size: 9px !important;
        max-width: 80px !important;
    }
    
    .search-controls select {
        min-width: 250px !important;
        font-size: 16px !important;
    }
    
    .search-controls .btn {
        padding: 10px 12px !important;
        font-size: 12px !important;
    }
    
    h2.titulo {
        font-size: 20px !important;
        margin-bottom: 20px !important;
    }
}

@media screen and (max-width: 480px) {
    .financeiro-container {
        padding: 5px !important;
        margin: 5px !important;
        width: calc(100% - 10px) !important;
    }
    
    .search-controls > div {
        flex-direction: column !important;
    }
    
    .search-controls .btn {
        width: 100% !important;
        margin: 2px 0 !important;
    }
    
    .table {
        font-size: 8px !important;
    }
    
    .table th, .table td {
        padding: 2px 1px !important;
        font-size: 8px !important;
        max-width: 60px !important;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const agora = new Date();
    const dataFormatada = agora.toLocaleString('pt-BR', {
        day: '2-digit',
        month: '2-digit', 
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
    const elementoDataPrint = document.getElementById('data-geracao-print');
    if (elementoDataPrint) {
        elementoDataPrint.textContent = 'Data: ' + dataFormatada;
    }
});

function criarModalEmail() {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
    `;
    
    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
        background: #e8e8e8;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        max-width: 400px;
        width: 90%;
        text-align: center;
        font-family: Arial, sans-serif;
    `;
    
    modalContent.innerHTML = `
        <h3 style="color: #026a84; margin-bottom: 20px; font-size: 20px;">游닎 Enviar Relat칩rio por Email</h3>
        <p style="color: #666; margin-bottom: 20px;">Digite o endere칞o de email de destino:</p>
        <input type="email" id="emailInput" placeholder="exemplo@email.com" style="
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
            box-sizing: border-box;
            outline: none;
        ">
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button id="cancelarBtn" style="
                background: #6c757d;
                color: white;
                border: none;
                padding: 12px 20px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                font-weight: bold;
            ">Cancelar</button>
            <button id="enviarBtn" style="
                background: #28a745;
                color: white;
                border: none;
                padding: 12px 20px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                font-weight: bold;
            ">Enviar</button>
        </div>
    `;
    
    modal.appendChild(modalContent);
    document.body.appendChild(modal);
    
    const emailInput = document.getElementById('emailInput');
    const cancelarBtn = document.getElementById('cancelarBtn');
    const enviarBtn = document.getElementById('enviarBtn');
    
    emailInput.focus();
    
    return new Promise((resolve) => {
        cancelarBtn.onclick = () => {
            document.body.removeChild(modal);
            resolve(null);
        };
        
        enviarBtn.onclick = () => {
            const email = emailInput.value.trim();
            if (email) {
                document.body.removeChild(modal);
                resolve(email);
            } else {
                emailInput.style.border = '2px solid #dc3545';
                emailInput.focus();
            }
        };
        
        emailInput.onkeypress = (e) => {
            if (e.key === 'Enter') {
                enviarBtn.click();
            }
        };
        
        modal.onclick = (e) => {
            if (e.target === modal) {
                cancelarBtn.click();
            }
        };
    });
}

async function enviarEmail() {
    const email = await criarModalEmail();
    if (email) {
        const periodo = new URLSearchParams(window.location.search).get('periodo') || '';
        
        let csrfToken = '';
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) {
            csrfToken = csrfInput.value;
        } else {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrftoken') {
                    csrfToken = value;
                    break;
                }
            }
        }
        
        fetch('/enviar-financeiro-email/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({email: email, periodo: periodo})
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Erro na requisi칞칚o: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                const mensagem = document.createElement('div');
                mensagem.className = 'alert alert-success';
                mensagem.style.cssText = 'position: fixed; top: 80px; right: 20px; z-index: 9999; background: white; color: #28a745; border: 2px solid #28a745; padding: 15px 20px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); font-weight: bold;';
                mensagem.textContent = 'Relat칩rio enviado por email com sucesso!';
                document.body.appendChild(mensagem);
                setTimeout(() => mensagem.remove(), 4000);
            } else {
                alert('Erro ao enviar email: ' + (data.error || 'Erro desconhecido'));
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao enviar email: ' + error.message);
        });
    }
}
</script>
{% endblock %}