{% extends "base.html" %}
{% load static %}

{% block title %}Relatório Financeiro{% endblock %}

{% block content %}
<div class="financeiro-container" style="max-width: 95%; width: 95%; margin: 0 auto; background: #e8e8e8; padding: 20px; border-radius: 30px;">
    <div class="print-header" style="display: none;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding: 0 80px;">
            <img src="{% static 'images/insumed_icon.png' %}" style="width: 100px; height: 100px;" alt="Logo">
            <h1 style="font-size: 48px; font-weight: bold; color: rgba(0, 0, 0, 0.12); margin: 0 120px; word-wrap: break-word; line-height: 1.2;">INSUMED</h1>
            <img src="{% static 'images/insumed_icon.png' %}" style="width: 100px; height: 100px;" alt="Logo">
        </div>
    </div>
    
    <h2 class="titulo screen-only">Relatório Financeiro</h2>
    
    <div class="print-info" style="display: none;">
        <h3 style="text-align: center; margin: 0 0 10px 0; color: #026a84; font-size: 24px;">Relatório Financeiro</h3>
        <p id="data-geracao-print" style="text-align: center; margin: 0; color: #026a84;"></p>
        {% if request.GET.q %}<p style="text-align: center; margin: 5px 0 0 0; color: #026a84;">Filtro aplicado: "{{ request.GET.q }}"</p>{% endif %}
    </div>

    {% csrf_token %}
    
    <div class="search-controls" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <select onchange="filtrarPeriodo(this.value)" style="padding: 8px; height: 35px; border: 1px solid #ddd; border-radius: 15px; font-size: 14px;">
                <option value="" {% if not periodo %}selected{% endif %}>Todos os Períodos</option>
                <option value="7" {% if periodo == '7' %}selected{% endif %}>Última Semana</option>
                <option value="30" {% if periodo == '30' %}selected{% endif %}>Último Mês</option>
                <option value="365" {% if periodo == '365' %}selected{% endif %}>Último Ano</option>
            </select>
        </div>
        <div style="display: flex; gap: 10px;">
            <button type="button" onclick="window.print()" class="btn" style="background: #17a2b8; padding: 12px 16px; height: 45px; font-size: 14px;">Imprimir</button>
            <button type="button" onclick="enviarEmail()" class="btn" style="background: #28a745; padding: 12px 16px; height: 45px; font-size: 14px;">Email</button>
            <a href="{% url 'exportar_financeiro_pdf' %}?{% if periodo %}periodo={{ periodo }}{% endif %}" class="btn" style="background: #dc3545; padding: 12px 16px; height: 45px; font-size: 14px; display: flex; align-items: center;">PDF</a>
        </div>
    </div>

    <!-- Tabela -->
    <div class="table-responsive">
        <table class="table table-striped table-hover" style="background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <thead style="background: #026a84; color: white;">
                <tr>
                    <th style="text-align: center; padding: 12px; font-weight: bold;">Produto</th>
                    <th style="text-align: center; padding: 12px; font-weight: bold;">Fornecedor</th>
                    <th style="text-align: center; padding: 12px; font-weight: bold;">Quantidade</th>
                    <th style="text-align: center; padding: 12px; font-weight: bold;">Unidade</th>
                    <th style="text-align: center; padding: 12px; font-weight: bold;">Valor Compra</th>
                    <th style="text-align: center; padding: 12px; font-weight: bold;">Valor Venda</th>
                    <th style="text-align: center; padding: 12px; font-weight: bold;">Estoque Atual</th>
                    <th style="text-align: center; padding: 12px; font-weight: bold;">Valor Total Compra</th>
                    <th style="text-align: center; padding: 12px; font-weight: bold;">Valor Total Venda</th>
                    <th style="text-align: center; padding: 12px; font-weight: bold;">Lucro Unitário</th>
                    <th style="text-align: center; padding: 12px; font-weight: bold;">Lucro Total</th>
                </tr>
            </thead>
            <tbody>
                {% for produto in produtos %}
                <tr class="produto-row" data-produto="{{ produto.nome|lower }}" data-fornecedor="{{ produto.fornecedor.nome|default:'sem fornecedor'|lower }}" data-codigo="{{ produto.codigo_barras|default:''|lower }}">
                    <td style="padding: 10px; text-align: left;">{{ produto.nome }}</td>
                    <td style="padding: 10px; text-align: center;">{{ produto.fornecedor.nome|default:"Sem fornecedor" }}</td>
                    <td style="padding: 10px; text-align: center;">{{ produto.quantidade }}</td>
                    <td style="padding: 10px; text-align: center;">{{ produto.unidade }}</td>
                    <td style="padding: 10px; text-align: center;">R$ {{ produto.preco_compra|default:"0,00" }}</td>
                    <td style="padding: 10px; text-align: center;">R$ {{ produto.preco }}</td>
                    <td style="padding: 10px; text-align: center; font-weight: bold;">{{ produto.quantidade }}</td>
                    <td style="padding: 10px; text-align: center;">R$ {{ produto.valor_total_compra|default:"0,00" }}</td>
                    <td style="padding: 10px; text-align: center;">R$ {{ produto.valor_total_venda }}</td>
                    <td style="padding: 10px; text-align: center;">
                        {% if produto.lucro_unitario >= 0 %}
                            <span style="color: #28a745; font-weight: bold;">R$ {{ produto.lucro_unitario }}</span>
                        {% else %}
                            <span style="color: #297f3a; font-weight: bold;">R$ {{ produto.lucro_unitario }}</span>
                        {% endif %}
                    </td>
                    <td style="padding: 10px; text-align: center;">
                        {% if produto.lucro_total >= 0 %}
                            <span style="color: #28a745; font-weight: bold;">R$ {{ produto.lucro_total }}</span>
                        {% else %}
                            <span style="color: #297f3a; font-weight: bold;">R$ {{ produto.lucro_total }}</span>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr id="nenhumProdutoFinanceiro">
                    <td colspan="11" style="text-align: center; padding: 20px; color: #666;">Nenhum produto encontrado</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr style="background: #f8f9fa; font-weight: bold; border-top: 2px solid #026a84;">
                    <td colspan="7" style="padding: 12px; text-align: right; font-size: 16px;">TOTAIS:</td>
                    <td style="padding: 12px; text-align: center; font-size: 16px;">R$ {{ total_compra|default:"0,00" }}</td>
                    <td style="padding: 12px; text-align: center; font-size: 16px;">R$ {{ total_venda|default:"0,00" }}</td>
                    <td style="padding: 12px; text-align: center;">-</td>
                    <td style="padding: 12px; text-align: center; font-size: 16px;">
                        {% if lucro_geral >= 0 %}
                            <span style="color: #28a745; font-weight: bold;">R$ {{ lucro_geral|default:"0,00" }}</span>
                        {% else %}
                            <span style="color: #297f3a; font-weight: bold;">R$ {{ lucro_geral|default:"0,00" }}</span>
                        {% endif %}
                    </td>
                </tr>
            </tfoot>
        </table>
    </div>
    
    <div class="print-footer" style="display: none;">
        <div style="margin-top: 30px; font-size: 12px; color: #666;">
            <p>Total de produtos: <span id="total-produtos">{{ produtos|length }}</span></p>
            <p>Relatório gerado automaticamente pelo Sistema INSUMED</p>
        </div>
    </div>

    <div style="height: 200px;"></div>
</div>

<script>
function filtrarPeriodo(periodo) {
    if (periodo) {
        window.location.href = `?periodo=${periodo}`;
    } else {
        window.location.href = window.location.pathname;
    }
}
</script>

<style>
.table-responsive {
    margin-top: 20px;
}

.table {
    margin-bottom: 0;
    font-size: 14px;
}

.table th {
    border: none;
    vertical-align: middle;
}

.table td {
    border: 1px solid #dee2e6;
    vertical-align: middle;
}

.table tbody tr:hover {
    background-color: #f8f9fa;
}

@media print {
    @page {
        margin: 0;
        size: A4 landscape;
        background: #013e6a !important;
    }
    * {
        -webkit-print-color-adjust: exact !important;
        color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
    body * {
        visibility: hidden;
    }
    html {
        background: #013e6a !important;
        -webkit-print-color-adjust: exact !important;
        color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
    body {
        margin: 0;
        padding: 0;
        background: #013e6a !important;
        -webkit-print-color-adjust: exact !important;
        color-adjust: exact !important;
        print-color-adjust: exact !important;
        min-height: 100vh;
        visibility: visible;
    }
    .financeiro-container, .financeiro-container * {
        visibility: visible;
    }
    .search-controls, .screen-only {
        display: none !important;
    }
    .print-header, .print-footer {
        display: block !important;
    }
    .print-info {
        display: block !important;
        background: #e8e8e8 !important;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 5px;
        margin-top: 130px;
    }
    .print-header {
        background: #013e6a !important;
        position: absolute;
        top: 0;
        left: 0;
        width: 100vw;
        height: 120px;
        z-index: 10;
        padding: 20px 0 !important;
        margin: 0 !important;
    }
    .print-header h1 {
        color: rgba(255, 255, 255, 0.3) !important;
    }
    .table {
        font-size: 10px;
        width: 100%;
        background: white !important;
    }
    .table th, .table td {
        padding: 3px;
        font-size: 10px;
    }
    .table thead th {
        background: #026a84 !important;
        color: white !important;
    }
}

.financeiro-container {
    border-radius: 30px 30px 30px 30px !important;
    margin-top: 20px !important;
}

.lista-container {
    border-radius: 30px 30px 30px 30px !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const agora = new Date();
    const dataFormatada = agora.toLocaleString('pt-BR', {
        day: '2-digit',
        month: '2-digit', 
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
    const elementoDataPrint = document.getElementById('data-geracao-print');
    if (elementoDataPrint) {
        elementoDataPrint.textContent = 'Data: ' + dataFormatada;
    }
});

function criarModalEmail() {
    const modal = document.createElement('div');
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
    `;
    
    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
        background: #e8e8e8;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        max-width: 400px;
        width: 90%;
        text-align: center;
        font-family: Arial, sans-serif;
    `;
    
    modalContent.innerHTML = `
        <h3 style="color: #026a84; margin-bottom: 20px; font-size: 20px;">📧 Enviar Relatório por Email</h3>
        <p style="color: #666; margin-bottom: 20px;">Digite o endereço de email de destino:</p>
        <input type="email" id="emailInput" placeholder="exemplo@email.com" style="
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
            box-sizing: border-box;
            outline: none;
        ">
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button id="cancelarBtn" style="
                background: #6c757d;
                color: white;
                border: none;
                padding: 12px 20px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                font-weight: bold;
            ">Cancelar</button>
            <button id="enviarBtn" style="
                background: #28a745;
                color: white;
                border: none;
                padding: 12px 20px;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                font-weight: bold;
            ">Enviar</button>
        </div>
    `;
    
    modal.appendChild(modalContent);
    document.body.appendChild(modal);
    
    const emailInput = document.getElementById('emailInput');
    const cancelarBtn = document.getElementById('cancelarBtn');
    const enviarBtn = document.getElementById('enviarBtn');
    
    emailInput.focus();
    
    return new Promise((resolve) => {
        cancelarBtn.onclick = () => {
            document.body.removeChild(modal);
            resolve(null);
        };
        
        enviarBtn.onclick = () => {
            const email = emailInput.value.trim();
            if (email) {
                document.body.removeChild(modal);
                resolve(email);
            } else {
                emailInput.style.border = '2px solid #dc3545';
                emailInput.focus();
            }
        };
        
        emailInput.onkeypress = (e) => {
            if (e.key === 'Enter') {
                enviarBtn.click();
            }
        };
        
        modal.onclick = (e) => {
            if (e.target === modal) {
                cancelarBtn.click();
            }
        };
    });
}

async function enviarEmail() {
    const email = await criarModalEmail();
    if (email) {
        const periodo = new URLSearchParams(window.location.search).get('periodo') || '';
        
        let csrfToken = '';
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) {
            csrfToken = csrfInput.value;
        } else {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrftoken') {
                    csrfToken = value;
                    break;
                }
            }
        }
        
        fetch('/enviar-financeiro-email/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({email: email, periodo: periodo})
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Erro na requisição: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                const mensagem = document.createElement('div');
                mensagem.className = 'alert alert-success';
                mensagem.style.cssText = 'position: fixed; top: 80px; right: 20px; z-index: 9999; background: white; color: #28a745; border: 2px solid #28a745; padding: 15px 20px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); font-weight: bold;';
                mensagem.textContent = 'Relatório enviado por email com sucesso!';
                document.body.appendChild(mensagem);
                setTimeout(() => mensagem.remove(), 4000);
            } else {
                alert('Erro ao enviar email: ' + (data.error || 'Erro desconhecido'));
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao enviar email: ' + error.message);
        });
    }
}
</script>
{% endblock %}